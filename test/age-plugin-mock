#!/usr/bin/env bash

set -e

# Mock age plugin for testing ReactorCA
# Implements the age plugin protocol with fake but valid-looking values

# Plugin handshake
echo "-> hello"
echo "age-plugin-v1"

# Mock values with proper prefixes
MOCK_RECIPIENT="age1mock1qwertyuiopasdfghjklzxcvbnmqwertyuiopasdfghjklzxcvbnm"
MOCK_IDENTITY="AGE-PLUGIN-MOCK-1QWERTYUIOPASDFGHJKLZXCVBNMQWERTYUIOPASDFGHJKLZXCVBNM"
FILE_KEY="0123456789abcdef0123456789abcdef"  # 32-byte hex key

while IFS= read -r line; do
    case "$line" in
        "-> add-recipient")
            # Read recipient string from next line
            read -r recipient_str
            # Read until empty line (consume any additional params)
            while read -r param && [[ -n "$param" ]]; do
                :
            done
            echo "-> recipient-stanza"
            echo "mock"
            echo "MOCKARG123"
            echo "MOCKWRAPPEDKEY456"
            echo ""
            ;;
        "-> add-identity")
            # Read identity string from next line
            read -r identity_str
            # Read until empty line
            while read -r param && [[ -n "$param" ]]; do
                :
            done
            # Don't echo anything for add-identity - just store it
            ;;
        "-> wrap-file-key")
            # Read file key to wrap (hex-encoded)
            read -r file_key
            # Read recipient stanzas until empty line
            while read -r stanza && [[ -n "$stanza" ]]; do
                :
            done
            echo "-> recipient-stanza"
            echo "mock"
            echo "WRAPPEDKEY789"
            echo ""
            ;;
        "-> unwrap-file-key")
            # Read stanzas until empty line
            while read -r stanza && [[ -n "$stanza" ]]; do
                :
            done
            echo "-> file-key"
            echo "$FILE_KEY"
            echo ""
            ;;
        "-> done")
            # End of protocol
            break
            ;;
        "")
            # Ignore empty lines
            ;;
        *)
            # Unknown command - ignore or log to stderr
            echo "Mock plugin: ignoring command '$line'" >&2
            ;;
    esac
done
